<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href='{% static "css/reports.css" %}'>
    <link rel="stylesheet" href='{% static "css/styles.css" %}'>
    <title>Создать отчет - Coronavirus web</title>
</head>
<body>
    <header>
        <img src="{% static 'images/header3.png' %}" alt="Icon" id="logo_img">
        <p id="title">Статистика коронавируса в России</p>
        <a href="/stats" id="back_link">Назад</a>
    </header>

    <main>
        <form id="report_creation" action="create/">
            <h1>Сформировать отчет:</h1>
            <div class="input_div">
                <label for="regionsInput">Регион</label>
                <input type="text" list="regions" id="regionsInput" name="region">
            </div>
            <datalist id="regions">
                <option value="Россия">
                <option value="Москва">
                <option value="Санкт-Петербург">
                <option value="Республика Адыгея">
                <option value="Республика Алтай">
                <option value="Республика Башкортостан">
                <option value="Республика Бурятия">
                <option value="Республика Дагестан">
                <option value="Республика Ингушетия">
                <option value="Кабардино-Балкарская Республика">
                <option value="Республика Калмыкия">
                <option value="Карачаево-Черкесская Республика">
                <option value="Республика Карелия">
                <option value="Республика Коми">
                <option value="Республика Крым">
                <option value="Республика Марий Эл">
                <option value="Республика Мордовия">
                <option value="Республика Саха (Якутия)">
                <option value="Республика Северная Осетия — Алания">
                <option value="Республика Татарстан">
                <option value="Республика Тыва">
                <option value="Удмуртская Республика">
                <option value="Республика Хакасия">
                <option value="Чеченская Республика">
                <option value="Чувашская Республика">
                <option value="Алтайский край">
                <option value="Забайкальский край">
                <option value="Камчатский край">
                <option value="Краснодарский край">
                <option value="Красноярский край">
                <option value="Пермский край">
                <option value="Приморский край">
                <option value="Ставропольский край">
                <option value="Хабаровский край">
                <option value="Амурская область">
                <option value="Архангельская область">
                <option value="Астраханская область">
                <option value="Белгородская область">
                <option value="Брянская область">
                <option value="Владимирская область">
                <option value="Волгоградская область">
                <option value="Вологодская область">
                <option value="Воронежская область">
                <option value="Ивановская область">
                <option value="Иркутская область">
                <option value="Калининградская область">
                <option value="Калужская область">
                <option value="Кемеровская область">
                <option value="Кировская область">
                <option value="Костромская область">
                <option value="Курганская область">
                <option value="Курская область">
                <option value="Ленинградская область">
                <option value="Липецкая область">
                <option value="Магаданская область">
                <option value="Московская область">
                <option value="Мурманская область">
                <option value="Нижегородская область">
                <option value="Новгородская область">
                <option value="Новосибирская область">
                <option value="Омская область">
                <option value="Оренбургская область">
                <option value="Орловская область">
                <option value="Пензенская область">
                <option value="Псковская область">
                <option value="Ростовская область">
                <option value="Рязанская область">
                <option value="Самарская область">
                <option value="Саратовская область">
                <option value="Сахалинская область">
                <option value="Свердловская область">
                <option value="Смоленская область">
                <option value="Тамбовская область">
                <option value="Тверская область">
                <option value="Томская область">
                <option value="Тульская область">
                <option value="Тюменская область">
                <option value="Ульяновская область">
                <option value="Челябинская область">
                <option value="Ярославская область">
                <option value="Севастополь">
                <option value="Еврейская автономная область">
                <option value="Ненецкий автономный округ">
                <option value="Ханты-Мансийский АО">
                <option value="Чукотский автономный округ">
                <option value="Ямало-Ненецкий автономный округ">
            </datalist>
            <div class="input_div">
                <label for="startDateInput">Дата начала отчетного периода</label>
                <input type="date" id="startDateInput" name="startDate">
            </div>
            <div class="input_div">
                <label for="endDateInput">Дата конца отчетного периода</label>
                <input type="date" id="endDateInput" name="endDate">
                <p id="dateError">Некорректный промежуток дат</p>
            </div>
            <div class="input_div">
                <input type="checkbox" id="MeasureAnalysisCb" name="measureAnalysis">
                <label for="MeasureAnalysisCb">Включить в отчет анализ мер</label>
            </div>
            <div class="input_div">
                <input type="checkbox" id="EmailCb" name="emailSending">
                <label for="EmailCb">Отправить отчет на электронную почту</label>
            </div>
            <div class="input_div">
                <label for="EmailInput" id="EmailLabel">Адрес</label>
                <input type="email" id="EmailInput" name="email"
                pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$">
            </div>
            <div class="input_div">
                <input type="submit" value="Создать отчет" id="createReport">
            </div>
        </form>
    </main>

    <footer>
        <p>Разработчик:</p>
        <form target="_blank" class="social_media_button" method="get" action="https://vk.com/careful_brainless">
            <button class='dev_link' id="dev_vk"><i class="fa fa-vk"></i></button>
        </form>
        <form target="_blank" class="social_media_button" method="get" action="https://github.com/CarefulBrainless">
            <button class='dev_link' id="dev_github"><i class="fa fa-github"></i></button>
        </form>
    </footer>
    <script>
        const regionInput = document.getElementById("regionsInput")
        const startDateInput = document.getElementById("startDateInput")
        const endDateInput = document.getElementById("endDateInput")
        const dateError = document.getElementById("dateError")
        const createButton = document.getElementById("createReport")
        const datalist = document.getElementById("regions")
        const measuresCb = document.getElementById("MeasureAnalysisCb")
        const emailCb = document.getElementById("EmailCb")
        const emailInput = document.getElementById("EmailInput")
        const emailLabel = document.getElementById("EmailLabel")
        emailInput.validity.valid = false;
        console.log(emailLabel)
        console.log('Е бой')

        function check(){
            visible = true;
            datesWrong = true;
            console.log(new Date());
            region = regionInput.value;
            startDate = new Date(startDateInput.value);
            endDate = new Date(endDateInput.value);
            //console.log(startDate);
            //console.log(endDate);

            // Проверка дат
            if (isNaN(startDate) || isNaN(endDate)){
                console.log('Есть пустые');
                dateError.innerHTML = "Введите обе даты";
            }
            else if (startDate > endDate){
                console.log('Начало позже конца');
                dateError.innerHTML = "Дата начала позже даты конца";
            }
            else if (endDate > new Date()){
                dateError.innerHTML = "Указанные даты еще не настали";
                console.log('Еще не настало');
            }
            else{
                console.log('Все нормал');
                datesWrong = false;
            }

            // Проверка выдачи ошибки дат
            //console.log(datesWrong);
            if(datesWrong){
                dateError.style.visibility = 'visible';
                visible = false;
            }
            else{
                dateError.style.visibility = 'hidden';
            }

            // Проверка корректности выбранного региона
            var options = datalist.getElementsByTagName('option');
            var optionVals = [];
            for (var i = 0; i < options.length; i += 1) {
              optionVals.push(options[i].value);
            }
            if (!optionVals.includes(region)){
                //console.log('not includes');
                visible = false;
            }

            // Проверка выбора почты и корректности почты
            if(emailCb.checked){
                emailInput.style.visibility = 'visible';
                emailLabel.style.visibility = 'visible';
                console.log(emailInput.checkValidity());
                console.log(emailInput.value);
                if (!emailInput.checkValidity() || emailInput.value==""){
                    console.log('damn');
                    visible = false;
                }
            }
            else{
                emailInput.style.visibility = 'hidden';
                emailLabel.style.visibility = 'hidden';
            }

            // Проверка установки состояния кнопки создания
            if (!visible){
                createButton.disabled = 'disabled';
                return false;
            }
            else{
                createButton.disabled = false;
                return true;
            }

        }

        startDateInput.addEventListener('change', check);
        endDateInput.addEventListener('change', check);
        regionInput.addEventListener('change', check);
        measuresCb.addEventListener('change', check);
        emailCb.addEventListener('change', check);
        emailInput.addEventListener('change', check);
        check();
    </script>
</body>
</html>